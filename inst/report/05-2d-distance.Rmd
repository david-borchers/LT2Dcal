---
output:
  pdf_document: default
  html_document: default
---

# 2D Distance Sampling

```{r 2D-setup, include=FALSE}
source("code.R")
b = c(4.89553757, 0.03561984); logphi = c(6.61348904, 4.84269089)
w = 1600; ystart = 1300
Nanimals = 200
match_limits = c(300,1000); match_param = c(450,5)
```

## Introduction

2D Distance Sampling builds on standard distance sampling by including the forward distance to the detected animal as well as the perpendicular distance. This removes the assumptions that the animals are uniformly distributed and that p(0) = 1, so this method is useful for situations where the other methods covered previously are not suitable. In particular, 2D distance sampling only requires the transect to be surveyed by one observer. This is not only more efficient but removes the issue of imperfect matching in mark-recapture methods.

Animal movement is also less problematic for 2D distance sampling. Like in standard distance sampling, as long as the movement is slow relative to the speed of the observers it will only cause a small amount of bias. Responsive movement can be accounted for in the animal distribution model so does not cause bias.

The likelihood equation for this model is: $$
L(N, \boldsymbol{\beta}) = {N\choose n}[1-p.(\boldsymbol{\beta},\boldsymbol{\phi})]^{N-n}\prod_{i = 1}^{n}\pi(x_i; \boldsymbol{\phi})S(t_i, x_i; \boldsymbol{\beta}) h(t_i, x_i; \boldsymbol{\beta}) 
$$ where:

\- $n$ is the number of animals observed and $N$ is the total in the population

\- $\pi(x_i; \boldsymbol{\phi})$ is the probability animal i is at perpendicular distance $x_i$. We will refer to $\pi(x_i; \boldsymbol{\phi})$ as the animal distribution function.

\- $h(t_i, x_i; \boldsymbol{\beta})$ is the probability animal i is detected at forward distance $y_i$ and perpendicular distance $x_i$. We will refer to $h(t_i, x_i; \boldsymbol{\beta})$ as the detection function.

\- $S(t_i, x_i; \boldsymbol{\beta}) = e^{-\int_{0}^{t_i}h(u,x;\boldsymbol{\beta})du}$ is the survivor function, i.e. the probability that animal i was undetected until time $t_i$

\- $p.(\boldsymbol{\beta},\boldsymbol{\phi})$ is the average probability of being detected in the region

In practice the conditional likelihood $L(\boldsymbol{\beta}|n)$ is used to calculate the maximum likelihood estimators. It is the same as the equation above, but without the leading binomial term, and so avoids considering the unseen animals. $\hat N$ is then estimated using a Horvitz-Thompson like estimator. The forward distance to the detected animal $y_i$ is used instead of the time $t_i$.

## Simulation: Non Uniform Distribution

We start by simulating attraction to the line by generating 200 animals using a half normal distribution with parameters `r exp(logphi)`. We used a inverse power detection function with parameters `r b`. The parameters chosen are the best model for the real snow leopard prey data.

```{r 2D-simulation, echo = F, warnings = F, cache = TRUE}
suppressWarnings(simdata <- MCR_2D(10,Nanimals, b=b, logphi = logphi, w= w, ystart = ystart, match_limits = match_limits, match_param = match_param))
bias_2d <- 100*(simdata$X2D - Nanimals)/Nanimals
```

We then fitted a model using a half normal distribution for animal density and inverse power detection function. We did not fit any other models for efficiency purposes. This gives a bias of `r mean(bias_2d)` $\pm$ `r 1.96*sqrt(var(bias_2d)/length(bias_2d))`, so we can confirm it is unbiased.

## Simulation: Comparison to Mark Recapture

Double observer mark recapture methods using the Chapman estimator are the current standard for estimating abundance of snow leopard prey. Our previous simulations have shown these have serious flaws, so we used both a 2D distance model and the Chapman estimator to estimate the abundance from the same data (simulated using the same parameters as above).

```{r 2D-histograms, echo = F, fig.cap="Histograms of abundance estimates using 2D distance sampling and the Chapman estimator"}
par(mfrow = c(1,2))
hist(simdata$X2D, main = "2D Distance", xlab = "Estimate of N")
abline(v = Nanimals, col = "blue")
hist(simdata$MCR.nomvmnt, main = "Chapman", xlab = "Estimate of N", xlim = c(min(simdata$MCR.nomvmnt),max(c(max(simdata$MCR.nomvmnt),Nanimals))))
abline(v = Nanimals, col = "blue")
```

The Chapman estimator was significantly negatively biased due to the unmodelled heterogeneity in the population. Adding random animal movement and imperfect matching gives a similar problem.

```{r imperfect-matching-histograms, echo = F, fig.cap = "Histograms of abundance estimates using the Chapman estimator with random movment"}
par(mfrow = c(1,2))
hist(simdata$MCR.move, main = "Perfect Matching", xlab = "Estimate of N", xlim = c(min(simdata$MCR.move),max(c(max(simdata$MCR.move),Nanimals))))
abline(v = Nanimals, col = "blue")
hist(simdata$MCR.imperf, main = "Imperfect Matching", xlab = "Estimate of N", xlim = c(min(simdata$MCR.imperf), max(c(max(simdata$MCR.imperf)+10,Nanimals))))
abline(v = Nanimals, col = "blue")
```

```{r coverage-probabilities, echo = FALSE}
cis_2D <- simdata[!is.na(simdata$X2D.lower)&!is.na(simdata$X2D.lower), 2:3]
covprob2D <- 100*length(cis_2D[cis_2D$X2D.lower <= Nanimals &cis_2D$X2D.upper >= Nanimals])/length(cis_2D)
cp.nomvmnt <- 100*length(simdata[simdata$nomvmnt.lower <= Nanimals & simdata$nomvmnt.upper >= Nanimals])/length(simdata$MCR.nomvmnt)
if(length(dim(cis_2D)[1] == 0)){
  print("Hessian matrices could not be computed for any 2D models")
  covprob2D <- NA}
cp.mvmnt <- 100*length(simdata[simdata$mvmnt.lower <= Nanimals & simdata$mvmnt.upper >= Nanimals])/length(simdata$MCR.move)
cp.imperf <- 100*length(simdata[simdata$imperf.lower <= Nanimals & simdata$nimperf.upper >= Nanimals])/length(simdata$MCR.imperf)
kable(data.frame("2D" = covprob2D,"nm" = cp.nomvmnt, "m" = cp.mvmnt,"i" = cp.imperf), col.names = c("2D", "Chapman without movement", "Chapman with movement", "Chapman with imperfect matching"), caption = "Coverage Probabilities")
```

From this it is clear that double-observer mark-recapture will yield significantly biased estimates of abundance of snow leopard prey, even if the animals do not move and the observers can perfectly match the individuals seen. We recommend instead using 2D distance sampling, as it accounts for the non uniform animal distribution as well as the declining detectability with distance. It is also requires less time to be spent surveying, as each transect only need to be walked once.

## Real Data Analysis

### Methods

We will now use the 2D distance framework to analyse the real snow leopard prey data. The observers surveyed 48 transects in 10 blocks and recorded the bearing of the path, the bearing of the group they saw and radial distance to the group where possible. There were 2 species included in the survey: ibex and argali. The observers had limited rangefinders so 49 of these observations had no distance data; 61 groups were behind the observers so did not have a valid "forward" distance. This left 132 usable observations.

Upon closer inspection, many detection distances (both perpendicular and forward) appeared to be rounded to zero, likely as a result of the bearings being rounded to the nearest 5 degrees. To prevent this from impacting the model fit we simply added a small random number to each zero observation.

```{r distance-histograms, fig.cap = "Histograms of forward and perpendicular distances"}
hist(DistData$distance, main = "Perpendicular Distance", xlab = "Distance")
hist(DistData$forward, main = "Forward Distance", ylab = "Distance")
```

From looking at the histograms of observed data we set the perpendicular truncation distance at `r w1` and the forward truncation distance at `r ystart1`. This excluded 2 outlier observations.\
We then fitted a series of model with different detection functions and animal distributions, and picked the one with the lowest AIC.

### Results

```{r fit-model, include = FALSE, warning=FALSE }
combined.ip0.hnorm <- LT2D.fit(DataFrameInput = jitterdf,
                            hr = 'ip0',
                            b = b,
                            ystart = ystart,      
                            pi.x = 'pi.hnorm',   
                            logphi = logphi,
                            w = w,
                            hessian = TRUE)
ibex.ip0.hnorm <- LT2D.fit(DataFrameInput = ibexjitter, 
                            hr = 'ip0',
                            b = c(5,1),
                            ystart = ystart,      
                            pi.x = 'pi.hnorm',   
                            logphi = c(5,5),
                            w = w,
                            hessian = TRUE)
argali.ip0 <- LT2D.fit(DataFrameInput = argalijitter,
                            hr = 'ip0',
                            b = c(4.5,0.75),
                            ystart = ystart,      
                            pi.x = 'pi.const',   
                            w = w,
                            hessian = TRUE)
try({ #what to do when can't get hessian?
  boot <- LT2D.bootstrap(combined.ip0.hnorm, r = 999, alpha = 0.05)
  ibexboot <- LT2D.bootstrap(ibex.ip0.hnorm, r = 999, alpha = 0.05)
})
  argaliboot <- LT2D.bootstrap(argali.ip0, r = 999, alpha = 0.05)

total.N <- combined.ip0.hnorm$ests[nrow(combined.ip0.hnorm$ests),ncol(combined.ip0.hnorm$ests)]
total.ibex <- ibex.ip0.hnorm$ests[nrow(ibex.ip0.hnorm$ests),ncol(ibex.ip0.hnorm$ests)]
total.argali <- argali.ip0$ests[nrow(argali.ip0$ests),ncol(argali.ip0$ests)]
```

Our best fitting model used the 2-parameter inverse power hazard detection function and a half normal distribution for the animal density. All of the best fitting models used a half normal animal distribution, which implies that the animals are attracted to the line rather than avoiding it as initially thought. This could be due to the non random line placement, as the observers travel along valleys or ridges that are easier to walk along so the animals could also favour the easier terrain.

```{r real-results-plot,echo = F, fig.cap = "Detection and distribution functions for best model (h1 and normal)"}
par(mfrow = c(2,2))
plot(combined.ip0.hnorm)
test.results <- gof.LT2D(combined.ip0.hnorm, plot = T)
```

We tried fitting different models to each species in the survey, but this had a higher AIC than the combined model (`r ibex.ip0.hnorm$fit$AIC + argali.ip0$fit$AIC` vs `r combined.ip0.hnorm$fit$AIC` for combined model). Interestingly, the argali appear to be uniformly distributed across the area whereas the ibex exhibit line attraction. However, there are only 39 argali groups recorded so further investigation is needed before drawing any conclusions. With more time we would fit a model that had species as a covariate.

The best combined model estimates there are `r total.N` individual animals in total.

```{r confidence-tables, echo = F, fig.margin = T}
ci.tabs <- data.frame("N" = c(total.N, total.ibex, total.argali), "95% CI L" = c(boot$ci[1], ibexboot$ci[1], argaliboot$ci[1]), "95%  CI U"= c(boot$ci[2], ibexboot$ci[2], argaliboot$ci[2]), row.names = c("Combined model", "Ibex only model", "Argali only model"))
kable(ci.tabs, col.names = c("Point Estimate","95% Bootstrap", "Confidence Interval"))
```

```{r estimate-by-block, echo = F}
ests <- combined.ip0.hnorm$ests[,c(1,2,4,6,7:11)]
rownames(ests) <- NULL
kable(ests, col.names = c("Stratum", "Groups Seen", "Total Transect Length ($km$)", "Stratum Area ($m^2$)", "Estimated Group Denisty", "Number of Groups", "Mean Size", "Individual Density", "Abundance Estimate" ), escape = FALSE)
```

## Further Reading

Borchers, D.L. and Cox, M.J. (2016). Distance sampling detection functions: 2D or not 2D? Biometrics, 73(2), pp.593--602. <doi:https://doi.org/10.1111/biom.12581>.

Borchers, D.L., Buckland, S.T. and Zucchini, W. (2002). Estimating Animal Abundance. [online] Springer Science & Business Media.

Suryawanshi, K.R., Bhatnagar, Y.V. and Mishra, C. (2012). Standardizing the double-observer survey method for estimating mountain ungulate prey of the endangered snow leopard. Oecologia, 169(3), pp.581--590. <doi:https://doi.org/10.1007/s00442-011-2237-0>.
